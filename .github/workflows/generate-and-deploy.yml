name: Generate Beats and Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  schedule:
    # Run daily at 00:00 UTC
    - cron: "0 0 * * *"
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Build project
        run: cargo build --release

      - name: Generate beats
        run: cargo run --release

      - name: Install ffmpeg and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg bc

      - name: Create video for YouTube
        run: ./scripts/create_video.sh

      - name: Check if video exists
        id: check_video
        run: |
          if [ -f output/youtube_video.mp4 ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Warning: Video file not found, skipping YouTube upload"
          fi

      - name: Get video metadata
        id: metadata
        if: steps.check_video.outputs.exists == 'true'
        run: ./scripts/get_video_metadata.sh

      - name: Authenticate with Google
        id: auth
        if: steps.check_video.outputs.exists == 'true'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: |
            {
              "client_id": "${{ secrets.YOUTUBE_CLIENT_ID }}",
              "client_secret": "${{ secrets.YOUTUBE_CLIENT_SECRET }}",
              "refresh_token": "${{ secrets.YOUTUBE_REFRESH_TOKEN }}",
              "type": "authorized_user"
            }

      - name: Upload to YouTube
        if: steps.check_video.outputs.exists == 'true'
        uses: google-github-actions/upload-youtube@v2
        with:
          path: output/youtube_video.mp4
          title: ${{ steps.metadata.outputs.title }}
          description: ${{ steps.metadata.outputs.description }}
          privacy_status: "public"

      - name: Create docs directory
        run: mkdir -p docs/songs

      - name: Copy song with date and metadata
        run: |
          # Find the newest MP3 and JSON files in output/ (generated with format: {author}_{song_name}_{date})
          MP3_FILE=$(ls -t output/*.mp3 2>/dev/null | head -1)
          JSON_FILE=$(ls -t output/*.json 2>/dev/null | head -1)

          if [ -z "$MP3_FILE" ]; then
            echo "Error: No MP3 file found in output/"
            exit 1
          fi

          # Extract filename without path
          MP3_BASENAME=$(basename "$MP3_FILE")
          JSON_BASENAME=$(basename "$JSON_FILE" 2>/dev/null || echo "")

          # Copy files preserving the original names
          cp "$MP3_FILE" docs/songs/
          if [ -n "$JSON_BASENAME" ] && [ -f "$JSON_FILE" ]; then
            cp "$JSON_FILE" docs/songs/
          fi

          echo "Generated MP3: $MP3_BASENAME"
          if [ -n "$JSON_BASENAME" ]; then
            echo "Metadata: $JSON_BASENAME"
            cat "docs/songs/$JSON_BASENAME"
          fi

      - name: Clean up old songs (keep last 7 songs)
        run: |
          cd docs/songs
          # Keep only the 7 most recent songs (MP3 and metadata) by modification time
          ls -t *.mp3 2>/dev/null | tail -n +8 | xargs -r rm -f
          ls -t *.json 2>/dev/null | tail -n +8 | xargs -r rm -f
          echo "Songs after cleanup:"
          ls -lh

      - name: Generate songs list JSON
        run: |
          cd docs/songs
          # Create a JSON file with list of available songs
          echo "[" > ../songs.json
          first=true
          for file in $(ls -t *.mp3 2>/dev/null); do
            if [ "$first" = true ]; then
              first=false
            else
              echo "," >> ../songs.json
            fi
            # Extract date from filename (format: {author}_{song_name}_{date}.mp3)
            # Date is the last part before .mp3, format YYYY-MM-DD
            date=$(echo $file | grep -oE '[0-9]{4}-[0-9]{2}-[0-9]{2}' | tail -1)
            size=$(stat -c%s "$file" 2>/dev/null)
            
            # Find corresponding metadata file (same base name but .json)
            metadata_file="${file%.mp3}.json"
            if [ -f "$metadata_file" ]; then
              # Read name and genre from metadata
              name=$(jq -r '.name // ""' "$metadata_file" 2>/dev/null || echo "")
              genre=$(jq -c '.genre // []' "$metadata_file" 2>/dev/null || echo "[]")
              echo "  {\"filename\": \"$file\", \"date\": \"$date\", \"size\": $size, \"name\": \"$name\", \"genre\": $genre}" >> ../songs.json
            else
              echo "  {\"filename\": \"$file\", \"date\": \"$date\", \"size\": $size}" >> ../songs.json
            fi
          done
          echo "" >> ../songs.json
          echo "]" >> ../songs.json
          cat ../songs.json

      - name: Commit and push songs to repository
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/songs/*.mp3 docs/songs/*.json docs/songs.json
          git diff --staged --quiet || git commit -m "ü•Å Add generated song $(date +%Y-%m-%d)"
          git push

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "docs"

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
