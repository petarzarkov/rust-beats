name: Generate Beats and Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  schedule:
    # Run daily at 00:00 UTC
    - cron: "0 0 * * *"
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Make scripts executable
        run: chmod +x scripts/manage_songs_fifo.sh

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Check compilation and run tests
        run: |
          # Ensure code compiles without errors
          cargo check --all-targets
          # Run all tests to catch function signature mismatches
          cargo test --all-targets
          # Note: We allow warnings (dead code, unused imports) but errors will fail the build

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg espeak-ng

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.14"
          cache: "pip"

      - name: Install Python dependencies
        run: |
          pip install -r scripts/requirements.txt

      - name: Build project
        run: cargo build --release

      - name: Generate beats
        run: cargo run --release

      - name: Create video for YouTube
        run: python3 scripts/create_video.py

      - name: Check if video exists
        id: check_video
        run: |
          if [ -f output/youtube_video.mp4 ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Warning: Video file not found, skipping YouTube upload"
          fi

      - name: Upload to YouTube
        if: steps.check_video.outputs.exists == 'true'
        env:
          YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
          YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
        run: python3 scripts/upload_youtube.py

      - name: Create docs directory
        run: mkdir -p docs/songs

      - name: Copy song with date and metadata
        run: |
          # Find the newest MP3 and JSON files in output/ (generated with format: {author}_{song_name}_{date})
          MP3_FILE=$(ls -t output/*.mp3 2>/dev/null | head -1)
          JSON_FILE=$(ls -t output/*.json 2>/dev/null | head -1)

          if [ -z "$MP3_FILE" ]; then
            echo "Error: No MP3 file found in output/"
            exit 1
          fi

          # Extract filename without path
          MP3_BASENAME=$(basename "$MP3_FILE")
          JSON_BASENAME=$(basename "$JSON_FILE" 2>/dev/null || echo "")

          # Copy files preserving the original names
          cp "$MP3_FILE" docs/songs/
          if [ -n "$JSON_BASENAME" ] && [ -f "$JSON_FILE" ]; then
            cp "$JSON_FILE" docs/songs/
          fi

          echo "Generated MP3: $MP3_BASENAME"
          if [ -n "$JSON_BASENAME" ]; then
            echo "Metadata: $JSON_BASENAME"
            cat "docs/songs/$JSON_BASENAME"
          fi

      - name: Manage songs (FIFO)
        run: scripts/manage_songs_fifo.sh

      - name: Commit and push songs to repository
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/songs/*.mp3 docs/songs/*.json docs/songs.json
          git diff --staged --quiet || git commit -m "ü•Å Add generated song $(date +%Y-%m-%d)"
          git push

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "docs"

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
